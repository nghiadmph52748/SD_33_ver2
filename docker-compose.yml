services:
  backend:
    build:
      context: ./BE_SP
      dockerfile: Dockerfile
    container_name: gearup-backend
    ports:
      - "8080:8080"
    environment:
      # SQL Server
      SQL_SERVER: ${SQL_SERVER:-localhost}
      SQL_DATABASE: ${SQL_DATABASE:-GearUp}
      SQL_USERNAME: ${SQL_USERNAME:-sa}
      SQL_PASSWORD: ${SQL_PASSWORD}
      SQL_PORT: ${SQL_PORT:-1433}
      # Cloudinary
      CLOUDINARY_CLOUD_NAME: ${CLOUDINARY_CLOUD_NAME}
      CLOUDINARY_API_KEY: ${CLOUDINARY_API_KEY}
      CLOUDINARY_API_SECRET: ${CLOUDINARY_API_SECRET}
      # VNPAY
      VNPAY_TMN_CODE: ${VNPAY_TMN_CODE}
      VNPAY_HASH_SECRET: ${VNPAY_HASH_SECRET}
      VNPAY_URL: ${VNPAY_URL:-https://sandbox.vnpayment.vn/paymentv2/vpcpay.html}
      VNPAY_RETURN_URL: ${VNPAY_RETURN_URL:-http://localhost:8080/api/payment/vnpay/return}
      VNPAY_IPN_URL: ${VNPAY_IPN_URL:-http://localhost:8080/api/payment/vnpay/ipn}
      # VietQR
      VIETQR_CLIENT_ID: ${VIETQR_CLIENT_ID}
      VIETQR_API_KEY: ${VIETQR_API_KEY}
      VIETQR_CHECKOUT_URL: ${VIETQR_CHECKOUT_URL:-https://api.vietqr.io/v2/generate}
      # Email
      SPRING_MAIL_HOST: ${SPRING_MAIL_HOST:-smtp.gmail.com}
      SPRING_MAIL_PORT: ${SPRING_MAIL_PORT:-587}
      SPRING_MAIL_USERNAME: ${SPRING_MAIL_USERNAME}
      SPRING_MAIL_PASSWORD: ${SPRING_MAIL_PASSWORD}
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_AUTH: ${SPRING_MAIL_PROPERTIES_MAIL_SMTP_AUTH:-true}
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_ENABLE: ${SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_ENABLE:-true}
      # OAuth
      OAUTH_GOOGLE_CLIENT_ID: ${OAUTH_GOOGLE_CLIENT_ID}
      # Frontend URL
      APP_FRONTEND_URL: ${APP_FRONTEND_URL:-http://localhost:5173}
      # AI Service
      AI_SERVICE_URL: http://ai-service:8001
    networks:
      - gearup-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - ai-service

  frontend-admin:
    build:
      context: ./view
      dockerfile: Dockerfile
      args:
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-http://localhost:8080/api}
        VITE_GHN_TOKEN: ${VITE_GHN_TOKEN}
        VITE_GHN_DEV_TOKEN: ${VITE_GHN_DEV_TOKEN}
        VITE_GHN_STORE_ID: ${VITE_GHN_STORE_ID}
    container_name: gearup-frontend-admin
    ports:
      - "5173:80"
    networks:
      - gearup-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

  frontend-client:
    build:
      context: ./banHangMain
      dockerfile: Dockerfile
      args:
        VITE_API_BASE_URL: ${VITE_API_BASE_URL_CLIENT:-http://localhost:8080/api}
        VITE_GHN_TOKEN: ${VITE_GHN_TOKEN_CLIENT}
        VITE_GHN_DEV_TOKEN: ${VITE_GHN_DEV_TOKEN_CLIENT}
        VITE_GHN_STORE_ID: ${VITE_GHN_STORE_ID_CLIENT}
        VITE_GOOGLE_CLIENT_ID: ${VITE_GOOGLE_CLIENT_ID}
        VITE_PROVINCES_API_URL: ${VITE_PROVINCES_API_URL:-https://provinces.open-api.vn/api}
        VITE_ADMIN_URL: ${VITE_ADMIN_URL:-http://localhost:5173}
    container_name: gearup-frontend-client
    ports:
      - "5174:80"
    networks:
      - gearup-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

  ai-service:
    build:
      context: ./ai_service
      dockerfile: Dockerfile
    container_name: gearup-ai-service
    ports:
      - "8001:8001"
    environment:
      # Google Gemini
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      GEMINI_MODEL: ${GEMINI_MODEL:-gemini-1.5-flash}
      # Database
      DB_HOST: ${AI_DB_HOST:-${SQL_SERVER:-localhost}}
      DB_PORT: ${AI_DB_PORT:-${SQL_PORT:-1433}}
      DB_NAME: ${AI_DB_NAME:-${SQL_DATABASE:-GearUp}}
      DB_USER: ${AI_DB_USER:-${SQL_USERNAME:-sa}}
      DB_PASSWORD: ${AI_DB_PASSWORD:-${SQL_PASSWORD}}
      # Redis (Optional)
      REDIS_HOST: ${REDIS_HOST:-localhost}
      REDIS_PORT: ${REDIS_PORT:-6379}
      # API
      API_PORT: 8001
      API_HOST: 0.0.0.0
    networks:
      - gearup-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s


networks:
  gearup-network:
    driver: bridge

